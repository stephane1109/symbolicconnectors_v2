<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text Annotator</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
        font-size: 14px;
      }
      body {
        margin: 0;
        padding: 0;
      }
      .container {
        display: grid;
        gap: 12px;
      }
      .text-box {
        border: 1px solid #d3d3d3;
        border-radius: 8px;
        padding: 12px;
        background: #fafafa;
        white-space: pre-wrap;
        line-height: 1.5;
        min-height: 120px;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      select,
      button {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #c7c7c7;
        font-size: 13px;
      }
      button {
        background: #1f77b4;
        color: #fff;
        cursor: pointer;
      }
      button[disabled] {
        background: #9bbad5;
        cursor: not-allowed;
      }
      .selection-info {
        font-size: 12px;
        color: #555;
      }
      ul {
        margin: 0;
        padding-left: 18px;
      }
      li {
        margin-bottom: 6px;
      }
      .empty {
        color: #777;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="text" class="text-box"></div>
      <div class="controls">
        <label for="label">Label:</label>
        <select id="label"></select>
        <button id="add" type="button" disabled>Ajouter l'annotation</button>
        <span id="selection" class="selection-info">Sélectionnez un texte.</span>
      </div>
      <div>
        <strong>Annotations</strong>
        <ul id="annotations"></ul>
        <div id="empty" class="empty">Aucune annotation.</div>
      </div>
    </div>
    <script>
      const Streamlit = {
        RENDER_EVENT: "streamlit:render",
        events: new EventTarget(),
        setComponentReady: () => {
          window.parent.postMessage(
            { isStreamlitMessage: true, type: "streamlit:componentReady", apiVersion: 1 },
            "*"
          );
        },
        setFrameHeight: (height) => {
          window.parent.postMessage(
            {
              isStreamlitMessage: true,
              type: "streamlit:setFrameHeight",
              height: height || document.body.scrollHeight,
            },
            "*"
          );
        },
        setComponentValue: (value) => {
          window.parent.postMessage(
            { isStreamlitMessage: true, type: "streamlit:setComponentValue", value },
            "*"
          );
        },
      };

      function dispatchRenderEvent(data) {
        const renderEvent = new CustomEvent(Streamlit.RENDER_EVENT, {
          detail: {
            args: data.args || {},
            disabled: data.disabled,
            theme: data.theme,
          },
        });
        Streamlit.events.dispatchEvent(renderEvent);
      }

      window.addEventListener("message", (event) => {
        const data = event.data;
        if (!data || data.type !== Streamlit.RENDER_EVENT) {
          return;
        }
        dispatchRenderEvent(data);
      });
    </script>
    <script>
      const textBox = document.getElementById("text");
      const labelSelect = document.getElementById("label");
      const addButton = document.getElementById("add");
      const selectionInfo = document.getElementById("selection");
      const annotationsList = document.getElementById("annotations");
      const emptyState = document.getElementById("empty");

      let currentText = "";
      let currentLabels = [];
      let annotations = [];
      let currentSelection = null;

      function selectionOffsets(container, range) {
        const preRange = range.cloneRange();
        preRange.selectNodeContents(container);
        preRange.setEnd(range.startContainer, range.startOffset);
        const start = preRange.toString().length;
        preRange.setEnd(range.endContainer, range.endOffset);
        const end = preRange.toString().length;
        return { start, end };
      }

      function renderAnnotations() {
        annotationsList.innerHTML = "";
        if (!annotations.length) {
          emptyState.style.display = "block";
          return;
        }
        emptyState.style.display = "none";
        annotations.forEach((annotation) => {
          const item = document.createElement("li");
          item.textContent = `[${annotation.start}, ${annotation.end}) ${annotation.label}: ${annotation.text}`;
          annotationsList.appendChild(item);
        });
      }

      function updateSelectionInfo() {
        if (!currentSelection) {
          selectionInfo.textContent = "Sélectionnez un texte.";
          addButton.disabled = true;
          return;
        }
        selectionInfo.textContent = `Sélection: ${currentSelection.start}-${currentSelection.end}`;
        addButton.disabled = !currentLabels.length;
      }

      function onMouseUp() {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) {
          currentSelection = null;
          updateSelectionInfo();
          return;
        }
        const range = selection.getRangeAt(0);
        if (!textBox.contains(range.commonAncestorContainer)) {
          currentSelection = null;
          updateSelectionInfo();
          return;
        }
        const offsets = selectionOffsets(textBox, range);
        if (offsets.start === offsets.end) {
          currentSelection = null;
          updateSelectionInfo();
          return;
        }
        currentSelection = {
          start: offsets.start,
          end: offsets.end,
          text: currentText.slice(offsets.start, offsets.end),
        };
        updateSelectionInfo();
      }

      function renderLabels() {
        labelSelect.innerHTML = "";
        currentLabels.forEach((label) => {
          const option = document.createElement("option");
          option.value = label;
          option.textContent = label;
          labelSelect.appendChild(option);
        });
        addButton.disabled = !currentLabels.length || !currentSelection;
      }

      function addAnnotation() {
        if (!currentSelection || !currentLabels.length) {
          return;
        }
        const label = labelSelect.value;
        const annotation = {
          start: currentSelection.start,
          end: currentSelection.end,
          label,
          text: currentSelection.text,
        };
        annotations = [...annotations, annotation];
        Streamlit.setComponentValue(annotations);
        renderAnnotations();
      }

      textBox.addEventListener("mouseup", onMouseUp);
      addButton.addEventListener("click", addAnnotation);

      function onRender(event) {
        const { text, labels, annotations: incomingAnnotations } = event.detail.args;
        currentText = text || "";
        currentLabels = labels || [];
        annotations = incomingAnnotations || [];
        textBox.textContent = currentText;
        renderLabels();
        renderAnnotations();
        updateSelectionInfo();
        Streamlit.setFrameHeight();
      }

      Streamlit.events.addEventListener(Streamlit.RENDER_EVENT, onRender);
      Streamlit.setComponentReady();
      Streamlit.setFrameHeight();
    </script>
  </body>
</html>
